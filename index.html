<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¸€å•ä¸€ç­” å˜èªå¸³ï¼ˆå›ºå®šURLç‰ˆï¼‰</title>
<style>
  :root { --bg:#0b0c0f; --card:#14161a; --muted:#8b96a8; --accent:#60a5fa; --ok:#34d399; --ng:#f87171; --text:#e5e7eb; }
  @media (prefers-color-scheme: light) {
    :root { --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --accent:#2563eb; --ok:#059669; --ng:#dc2626; --text:#0f172a; }
  }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
         background:var(--bg); color:var(--text); }
  .wrap { max-width:900px; margin:24px auto; padding: 0 16px; }
  header { display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px;}
  header h1 { font-size:20px; margin:0; }
  .controls { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .btn{
    background:var(--card); color:var(--text); border:1px solid #2b3038; padding:10px 12px; border-radius:12px; cursor:pointer;
  }
  .btn:hover{ border-color:var(--accent); }
  .select { padding:10px 12px; border-radius:12px; border:1px solid #2b3038; background:var(--card); color:var(--text); }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .grow { flex:1 1 auto; }
  .card {
    user-select:none; background:var(--card); border:1px solid #2b3038; border-radius:16px; padding:28px; min-height:180px;
    display:flex; align-items:center; justify-content:center; text-align:center; font-size:22px; line-height:1.6;
    transition: transform .15s ease;
  }
  .card:hover { transform: translateY(-1px); border-color:#3a4250; }
  .muted { color:var(--muted); font-size:12px; }
  .grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .stats { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
  .pill { font-size:12px; padding:6px 8px; border-radius:999px; background:#1f232b; border:1px solid #2b3038;}
  .pill.ok{ color:var(--ok); border-color:var(--ok); background:color-mix(in oklab, var(--ok) 15%, transparent); }
  .pill.ng{ color:var(--ng); border-color:var(--ng); background:color-mix(in oklab, var(--ng) 12%, transparent); }
  progress { width:100%; height:10px; accent-color: var(--accent);}
  .kbd { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; padding:2px 6px; border:1px solid #2b3038; border-bottom-width:2px; border-radius:6px; background:#0f1116;}
  .hidden { display:none !important; }
  .hint { font-size:14px; color:var(--muted); margin-top:8px; }
  .footer { margin-top:24px; font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ä¸€å•ä¸€ç­” å˜èªå¸³</h1>
    <div class="controls">
      <button id="btn-reload" class="btn" title="ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
      <button id="btn-shuffle" class="btn" title="ã‚«ãƒ¼ãƒ‰ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«">ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
      <button id="btn-reset" class="btn" title="é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ">â™» é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="btn-export" class="btn" title="é€²æ—ã‚’æ›¸ãå‡ºã—ï¼ˆUTF-8ï¼‰">ğŸ’¾ é€²æ—ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <label class="btn" role="button" title="ä¿å­˜ã—ãŸé€²æ—JSONã‚’èª­ã¿è¾¼ã¿">
        ğŸ“¥ é€²æ—ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        <input id="progress-file" type="file" accept=".json" style="display:none" />
      </label>
    </div>
  </header>

  <section class="row">
    <div class="grow stats">
      <span class="pill" id="deckName">ãƒ‡ãƒƒã‚­ï¼šæœªãƒ­ãƒ¼ãƒ‰</span>
      <span class="pill">ç·æ•° <b id="stat-total">0</b></span>
      <span class="pill ok">æ­£è§£ <b id="stat-ok">0</b></span>
      <span class="pill ng">èª¤ç­” <b id="stat-ng">0</b></span>
      <span class="pill">æ®‹ã‚Š <b id="stat-left">0</b></span>
    </div>
    <div class="row">
      <select id="mode" class="select" title="å‡ºé¡Œæ–¹å‘">
        <option value="name2value">å•é¡Œï¼šç”¨èª â†’ ç­”ãˆï¼šèª¬æ˜</option>
        <option value="value2name">å•é¡Œï¼šèª¬æ˜ â†’ ç­”ãˆï¼šç”¨èª</option>
      </select>
      <label class="row btn" role="button" title="ç­”ãˆã‚’è‡ªå‹•ã§è¡¨ç¤º">
        <input id="autoReveal" type="checkbox" style="margin-right:6px" />
        è‡ªå‹•ã§ç­”ãˆè¡¨ç¤º
      </label>
    </div>
  </section>

  <section style="margin:12px 0">
    <progress id="progress" max="100" value="0"></progress>
  </section>

  <section id="qa">
    <div id="question" class="card" tabindex="0" title="ã‚¯ãƒªãƒƒã‚¯/ã‚¹ãƒšãƒ¼ã‚¹ã§ã‚ãã‚‹">ã“ã“ã«å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div id="answer" class="card hidden" title="ç­”ãˆ">ã“ã“ã«ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    <div class="hint">æ“ä½œï¼š<span class="kbd">Space</span> ã‚ãã‚‹ / <span class="kbd">Enter</span> æ¬¡ã¸ / <span class="kbd">â† â†’</span> å‰å¾Œ / <span class="kbd">1</span> æ­£è§£ / <span class="kbd">2</span> ã‚‚ã†ä¸€åº¦</div>
  </section>

  <section class="grid" style="margin-top:12px">
    <button id="btn-show" class="btn">ğŸ‘ï¸â€ğŸ—¨ï¸ ç­”ãˆã‚’è¡¨ç¤ºï¼ˆSpaceï¼‰</button>
    <button id="btn-hide" class="btn">ğŸ™ˆ ç­”ãˆã‚’éš ã™</button>
    <button id="btn-prev" class="btn">â¬… å‰ã¸</button>
    <button id="btn-next" class="btn">æ¬¡ã¸ â¡</button>
    <button id="btn-correct" class="btn" style="border-color:var(--ok);">âœ… æ­£è§£ï¼ˆ1ï¼‰</button>
    <button id="btn-wrong" class="btn" style="border-color:var(--ng);">âŒ ã‚‚ã†ä¸€åº¦ï¼ˆ2ï¼‰</button>
  </section>

  <details style="margin-top:16px">
    <summary>ğŸ”§ èª¬æ˜ / ä»•æ§˜</summary>
    <div class="muted" style="margin-top:8px">
      <ul>
        <li>ãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã« <code>https://ymtklab.github.io/api/api.json</code> ã‹ã‚‰UTF-8ã§å–å¾—ã—ã¾ã™ï¼ˆJSONé…åˆ— or JSON Lineså¯¾å¿œï¼‰ã€‚</li>
        <li>å„è¦ç´ ã¯ <code>{ "name": "...", "value": "..." }</code> ã‚’æƒ³å®šã€‚</li>
        <li>é€²æ—ã¯ <code>localStorage</code> ã«è‡ªå‹•ä¿å­˜ã€‚å†…å®¹ãƒãƒƒã‚·ãƒ¥ã§ãƒ‡ãƒƒã‚­è­˜åˆ¥ã—ã¾ã™ã€‚</li>
        <li>ã€Œã‚‚ã†ä¸€åº¦ã€ãƒãƒ¼ã‚¯ã®ã‚«ãƒ¼ãƒ‰ã¯å„ªå…ˆçš„ã«å†å‡ºé¡Œã—ã¾ã™ã€‚</li>
      </ul>
    </div>
  </details>

  <div class="footer">
    Â© Frontend-only Flashcards / å›ºå®šURLãƒ»UTF-8ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€²æ—
  </div>
</div>

<script>
(() => {
  /*** è¨­å®š ***/
  const DATA_URL = "https://ymtklab.github.io/api/api.json";

  /*** çŠ¶æ…‹ ***/
  let cards = [];             // {name, value}
  let order = [];             // å‡ºé¡Œé † indexé…åˆ—
  let cursor = 0;             // ç¾åœ¨ä½ç½®ï¼ˆorderã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
  let reveal = false;         // ç­”ãˆè¡¨ç¤ºä¸­ã‹
  let deckHash = "";          // ãƒ‡ãƒ¼ã‚¿å†…å®¹ã‹ã‚‰ä½œã‚‹ãƒãƒƒã‚·ãƒ¥ï¼ˆé€²æ—ã‚­ãƒ¼ï¼‰
  let stats = { ok: 0, ng: 0 }; // æ­£è§£/èª¤ç­”æ•°
  let wrongPool = new Set();  // èª¤ç­”ã‚«ãƒ¼ãƒ‰ index
  let deckName = "api (remote)";

  /*** DOM ***/
  const el = {
    progressFile: document.getElementById('progress-file'),
    question: document.getElementById('question'),
    answer: document.getElementById('answer'),
    show: document.getElementById('btn-show'),
    hide: document.getElementById('btn-hide'),
    prev: document.getElementById('btn-prev'),
    next: document.getElementById('btn-next'),
    correct: document.getElementById('btn-correct'),
    wrong: document.getElementById('btn-wrong'),
    shuffle: document.getElementById('btn-shuffle'),
    reset: document.getElementById('btn-reset'),
    reload: document.getElementById('btn-reload'),
    export: document.getElementById('btn-export'),
    mode: document.getElementById('mode'),
    autoReveal: document.getElementById('autoReveal'),
    statTotal: document.getElementById('stat-total'),
    statOk: document.getElementById('stat-ok'),
    statNg: document.getElementById('stat-ng'),
    statLeft: document.getElementById('stat-left'),
    progress: document.getElementById('progress'),
    deckName: document.getElementById('deckName'),
  };

  /*** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ***/
  const djb2 = (str) => { // ç°¡æ˜“ãƒãƒƒã‚·ãƒ¥ï¼ˆãƒ‡ãƒƒã‚­è­˜åˆ¥ç”¨ï¼‰
    let h = 5381;
    for (let i=0;i<str.length;i++) h = ((h << 5) + h) ^ str.charCodeAt(i);
    return (h>>>0).toString(36);
  };
  const saveKey = () => `flashcards.${deckHash}.v1`;
  const pickSide = (c) => {
    const m = el.mode.value;
    return { q: m === 'name2value' ? c.name : c.value,
             a: m === 'name2value' ? c.value : c.name };
  };
  const fisherShuffle = (arr) => {
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  };

  /*** é€²æ—ä¿å­˜/å¾©å…ƒ ***/
  function saveProgress() {
    if (!deckHash) return;
    const data = {
      deckName, deckHash, order, cursor, stats, wrongPool: Array.from(wrongPool),
      mode: el.mode.value, autoReveal: el.autoReveal.checked,
      timestamp: Date.now()
    };
    localStorage.setItem(saveKey(), JSON.stringify(data));
  }
  function loadProgress(hash) {
    const raw = localStorage.getItem(`flashcards.${hash}.v1`);
    if (!raw) return false;
    try {
      const p = JSON.parse(raw);
      if (p.deckHash !== hash) return false;
      order = p.order || order;
      cursor = Math.min(Math.max(0, p.cursor||0), Math.max(0, order.length-1));
      stats = p.stats || stats;
      wrongPool = new Set(p.wrongPool || []);
      el.mode.value = p.mode || 'name2value';
      el.autoReveal.checked = !!p.autoReveal;
      return true;
    } catch { return false; }
  }

  /*** æç”» ***/
  function updateStats() {
    el.statTotal.textContent = cards.length;
    el.statOk.textContent = stats.ok;
    el.statNg.textContent = stats.ng;
    const left = Math.max(0, order.length - cursor - 1);
    el.statLeft.textContent = left;
    const done = cards.length ? Math.round(((cursor+1)/order.length)*100) : 0;
    el.progress.max = 100;
    el.progress.value = done;
    el.deckName.textContent = `ãƒ‡ãƒƒã‚­ï¼š${deckName}`;
  }
  function renderQA() {
    if (!cards.length) {
      el.question.textContent = "ãƒªãƒ¢ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ï¼ˆğŸ”„ å†èª­ã¿è¾¼ã¿ï¼‰";
      el.answer.textContent = "";
      return;
    }
    const idx = order[cursor] ?? 0;
    const sides = pickSide(cards[idx]);
    el.question.textContent = sides.q || "(ç©º)";
    el.answer.textContent = sides.a || "(ç©º)";
    el.answer.classList.toggle('hidden', !reveal);
    el.question.classList.toggle('hidden', reveal);
    updateStats();
  }

  /*** å‡ºé¡Œåˆ¶å¾¡ ***/
  function nextCard() {
    if (!cards.length) return;
    if (wrongPool.size > 0 && Math.random() < 0.6) {
      const pick = [...wrongPool][Math.floor(Math.random() * wrongPool.size)];
      const pos = order.indexOf(pick);
      if (pos > cursor) {
        order.splice(pos,1);
        order.splice(cursor+1,0,pick);
      }
    }
    cursor = Math.min(order.length-1, cursor+1);
    reveal = !!el.autoReveal.checked;
    renderQA();
    saveProgress();
  }
  function prevCard() {
    if (!cards.length) return;
    cursor = Math.max(0, cursor-1);
    reveal = !!el.autoReveal.checked;
    renderQA();
    saveProgress();
  }
  function showAnswer(flag=true) {
    reveal = flag;
    renderQA();
  }
  function markCorrect() {
    stats.ok++;
    const idx = order[cursor];
    wrongPool.delete(idx);
    saveProgress();
    nextCard();
  }
  function markWrong() {
    stats.ng++;
    const idx = order[cursor];
    wrongPool.add(idx);
    const pos = order.indexOf(idx);
    if (pos !== -1 && pos < order.length-1) {
      order.splice(pos,1);
      order.push(idx);
    }
    saveProgress();
    nextCard();
  }

  /*** ãƒªãƒ¢ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ï¼ˆUTF-8, no-storeï¼‰ ***/
  async function fetchRemote() {
    try {
      const resp = await fetch(DATA_URL, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const text = await resp.text(); // æ–‡å­—åˆ—ã¨ã—ã¦å–å¾—ï¼ˆUTF-8ï¼‰
      await loadDeckFromText(text);
      // ãƒ‡ãƒƒã‚­åã¯URLæœ«å°¾ã‚’æ¡ç”¨
      deckName = "api (remote)";
      renderQA();
      saveProgress();
    } catch (e) {
      console.error(e);
      alert(`ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${DATA_URL}\nã‚¨ãƒ©ãƒ¼: ${e.message}`);
    }
  }

  async function loadDeckFromText(text) {
    const t = text.replace(/^\uFEFF/, ''); // BOMé™¤å»
    deckHash = djb2(t);
    let list = [];
    try {
      const maybe = JSON.parse(t);
      if (Array.isArray(maybe)) list = maybe;
      else throw new Error("not array");
    } catch {
      // JSON Lineså¯¾å¿œ
      list = t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map((line,i)=>{
        try { return JSON.parse(line); } catch { console.warn("JSONL parse error at line", i+1); return null; }
      }).filter(Boolean);
    }
    cards = list.map(x => ({ name: String(x.name ?? "").trim(), value: String(x.value ?? "").trim() }))
                .filter(x => x.name || x.value);
    if (!cards.length) {
      throw new Error("ã‚«ãƒ¼ãƒ‰ãŒ0ä»¶ã§ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦ç¢ºèªï¼‰");
    }
    order = Array.from(cards.keys());
    // æ—¢å­˜é€²æ—ã®å¾©å…ƒï¼ˆåŒä¸€å†…å®¹ã®ã¨ãã®ã¿ï¼‰
    if (!loadProgress(deckHash)) {
      // æ–°è¦ãƒ­ãƒ¼ãƒ‰æ™‚ã¯ã‚·ãƒ£ãƒƒãƒ•ãƒ«é–‹å§‹
      fisherShuffle(order);
      cursor = 0; reveal = !!el.autoReveal.checked; stats = { ok:0, ng:0 }; wrongPool.clear();
    }
  }

  /*** ãƒœã‚¿ãƒ³/ã‚­ãƒ¼ ***/
  el.show.addEventListener('click', ()=> showAnswer(true));
  el.hide.addEventListener('click', ()=> showAnswer(false));
  el.next.addEventListener('click', nextCard);
  el.prev.addEventListener('click', prevCard);
  el.correct.addEventListener('click', markCorrect);
  el.wrong.addEventListener('click', markWrong);
  el.shuffle.addEventListener('click', ()=>{
    if (!cards.length) return;
    fisherShuffle(order);
    cursor = 0;
    reveal = !!el.autoReveal.checked;
    renderQA(); saveProgress();
  });
  el.reset.addEventListener('click', ()=>{
    if (!confirm("é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    stats = {ok:0, ng:0}; wrongPool.clear();
    order = Array.from(cards.keys());
    fisherShuffle(order);
    cursor = 0; reveal = false; renderQA(); saveProgress();
  });
  el.mode.addEventListener('change', ()=>{ reveal = !!el.autoReveal.checked; renderQA(); saveProgress(); });
  el.autoReveal.addEventListener('change', ()=>{ reveal = !!el.autoReveal.checked; renderQA(); saveProgress(); });
  el.reload.addEventListener('click', fetchRemote);

  document.addEventListener('keydown', (ev)=>{
    if (ev.target && /input|textarea|select/.test(ev.target.tagName.toLowerCase())) return;
    if (ev.code === 'Space') { ev.preventDefault(); showAnswer(!reveal); }
    else if (ev.code === 'Enter') { ev.preventDefault(); nextCard(); }
    else if (ev.code === 'ArrowRight') { nextCard(); }
    else if (ev.code === 'ArrowLeft') { prevCard(); }
    else if (ev.key === '1') { markCorrect(); }
    else if (ev.key === '2') { markWrong(); }
  });

  /*** é€²æ—ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆUTF-8ï¼‰ ***/
  el.export.addEventListener('click', ()=>{
    if (!deckHash) { alert("å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚"); return; }
    const data = localStorage.getItem(saveKey()) || "{}";
    const blob = new Blob([data], { type:"application/json;charset=utf-8" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `progress.${deckHash}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  el.progressFile.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const text = await f.text();
    try {
      const p = JSON.parse(text);
      if (!p.deckHash) throw new Error("ä¸æ­£ãªå½¢å¼ã§ã™");
      if (p.deckHash !== deckHash) {
        if (!confirm("èª­ã¿è¾¼ã‚€é€²æ—ã¯ç¾åœ¨ã®ãƒ‡ãƒƒã‚­ã¨ç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
      }
      localStorage.setItem(`flashcards.${p.deckHash}.v1`, JSON.stringify(p));
      if (p.deckHash === deckHash) { loadProgress(deckHash); renderQA(); }
      alert("é€²æ—ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
    } catch (e) {
      alert("é€²æ—JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    }
  });

  /*** èµ·å‹•æ™‚ã«å›ºå®šURLã‹ã‚‰å–å¾— ***/
  fetchRemote();
  renderQA();
})();
</script>
</body>
</html>
